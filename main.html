<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VGT Revenue Report Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }

        .upload-section.dragover {
            background: #e8ebff;
            border-color: #764ba2;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: transform 0.2s ease;
            display: inline-block;
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .file-name {
            margin-top: 15px;
            color: #666;
            font-style: italic;
        }

        .venue-section {
            display: none;
            margin-top: 30px;
        }

        .venue-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 1.1em;
        }

        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: white;
        }

        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .info-box {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .info-box ul {
            list-style: none;
            padding-left: 0;
        }

        .info-box li {
            padding: 5px 0;
            color: #666;
        }

        .status-message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VGT Revenue Report Generator</h1>
            <p>Upload XML file and generate PDF reports for venues</p>
        </div>

        <div class="content">
            <div class="upload-section" id="uploadSection">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".xml" />
                    <label for="fileInput" class="file-label">
                        üìÅ Choose XML File
                    </label>
                </div>
                <div class="file-name" id="fileName">No file selected</div>
            </div>

            <div id="statusMessage" class="status-message"></div>

            <div class="venue-section" id="venueSection">
                <div class="form-group">
                    <label for="venueSelect">Select Venue:</label>
                    <select id="venueSelect">
                        <option value="">-- Select a venue --</option>
                    </select>
                </div>

                <button class="btn" id="generateBtn" disabled>Generate PDF Report</button>

                <div class="info-box">
                    <h3>üìä Report Information</h3>
                    <ul id="venueInfo">
                        <li>Select a venue to see details</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let xmlData = null;
        let venuesData = {};

        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const uploadSection = document.getElementById('uploadSection');
        const venueSection = document.getElementById('venueSection');
        const venueSelect = document.getElementById('venueSelect');
        const generateBtn = document.getElementById('generateBtn');
        const statusMessage = document.getElementById('statusMessage');
        const venueInfo = document.getElementById('venueInfo');

        // Drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.xml')) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            fileName.textContent = file.name;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const parser = new DOMParser();
                    xmlData = parser.parseFromString(e.target.result, 'text/xml');
                    parseXMLData();
                    populateVenueDropdown();
                    venueSection.classList.add('active');
                    showStatus('File loaded successfully!', 'success');
                } catch (error) {
                    showStatus('Error parsing XML file: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function parseXMLData() {
            venuesData = {};
            const venues = xmlData.getElementsByTagName('Venue');
            
            for (let venue of venues) {
                const venueName = venue.getAttribute('Venue_Name');
                const siteLicense = venue.getAttribute('Site_License_Number');
                
                venuesData[venueName] = {
                    siteLicense: siteLicense,
                    periods: []
                };
                
                const periods = venue.getElementsByTagName('Accounting_Period_ID');
                for (let period of periods) {
                    const periodData = {
                        startDate: period.getAttribute('Accounting_Period_StartDate'),
                        machines: []
                    };
                    
                    const machines = period.getElementsByTagName('Unique_IdentifierGrp');
                    for (let machine of machines) {
                        periodData.machines.push({
                            spotName: machine.getAttribute('Spot_Name'),
                            uniqueId: machine.getAttribute('Unique_Identifier'),
                            licenseNumber: machine.getAttribute('License_Number'),
                            cashIn: parseFloat(machine.getAttribute('Cash_In')),
                            voucherIn: parseFloat(machine.getAttribute('Voucher_In')),
                            fundsIn: parseFloat(machine.getAttribute('Funds_In')),
                            fundsOut: parseFloat(machine.getAttribute('Funds_Out')),
                            currentCredits: parseFloat(machine.getAttribute('Current_Credits')),
                            netTerminalIncome: parseFloat(machine.getAttribute('Net_Terminal_Income')),
                            amtPlayed: parseFloat(machine.getAttribute('Amt_Played')),
                            amountWon: parseFloat(machine.getAttribute('Amount_Won')),
                            netPlay: parseFloat(machine.getAttribute('Net_Play'))
                        });
                    }
                    
                    venuesData[venueName].periods.push(periodData);
                }
            }
        }

        function populateVenueDropdown() {
            venueSelect.innerHTML = '<option value="">-- Select a venue --</option>';
            for (let venueName in venuesData) {
                const option = document.createElement('option');
                option.value = venueName;
                option.textContent = venueName;
                venueSelect.appendChild(option);
            }
        }

        venueSelect.addEventListener('change', () => {
            const selectedVenue = venueSelect.value;
            if (selectedVenue) {
                generateBtn.disabled = false;
                displayVenueInfo(selectedVenue);
            } else {
                generateBtn.disabled = true;
                venueInfo.innerHTML = '<li>Select a venue to see details</li>';
            }
        });

        function displayVenueInfo(venueName) {
            const venue = venuesData[venueName];
            let totalFundsIn = 0;
            let totalFundsOut = 0;
            let totalNetIncome = 0;
            let machineCount = 0;
            
            venue.periods.forEach(period => {
                period.machines.forEach(machine => {
                    totalFundsIn += machine.fundsIn;
                    totalFundsOut += machine.fundsOut;
                    totalNetIncome += machine.netTerminalIncome;
                });
                machineCount = Math.max(machineCount, period.machines.length);
            });
            
            venueInfo.innerHTML = `
                <li><strong>Venue:</strong> ${venueName}</li>
                <li><strong>License #:</strong> ${venue.siteLicense}</li>
                <li><strong>Number of Machines:</strong> ${machineCount}</li>
                <li><strong>Number of Periods:</strong> ${venue.periods.length}</li>
                <li><strong>Total Funds In:</strong> $${totalFundsIn.toFixed(2)}</li>
                <li><strong>Total Funds Out:</strong> $${totalFundsOut.toFixed(2)}</li>
                <li><strong>Total Net Income:</strong> $${totalNetIncome.toFixed(2)}</li>
            `;
        }

        generateBtn.addEventListener('click', () => {
            const selectedVenue = venueSelect.value;
            if (selectedVenue) {
                generatePDF(selectedVenue);
            }
        });

        function generatePDF(venueName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const venue = venuesData[venueName];
            
            // Title
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('VGT Revenue Report', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Establishment: ${venueName}`, 20, 35);
            doc.text(`Site License: ${venue.siteLicense}`, 20, 42);
            
            // Get date range
            const startDate = new Date(venue.periods[0].startDate).toLocaleDateString();
            const endDate = new Date(venue.periods[venue.periods.length - 1].startDate).toLocaleDateString();
            doc.text(`Period: ${startDate} to ${endDate}`, 20, 49);
            
            let yPosition = 60;
            
            // Summary for each machine
            const machineMap = {};
            venue.periods.forEach(period => {
                period.machines.forEach(machine => {
                    if (!machineMap[machine.spotName]) {
                        machineMap[machine.spotName] = {
                            uniqueId: machine.uniqueId,
                            licenseNumber: machine.licenseNumber,
                            fundsIn: 0,
                            fundsOut: 0,
                            netIncome: 0,
                            amtPlayed: 0,
                            amtWon: 0
                        };
                    }
                    machineMap[machine.spotName].fundsIn += machine.fundsIn;
                    machineMap[machine.spotName].fundsOut += machine.fundsOut;
                    machineMap[machine.spotName].netIncome += machine.netTerminalIncome;
                    machineMap[machine.spotName].amtPlayed += machine.amtPlayed;
                    machineMap[machine.spotName].amtWon += machine.amountWon;
                });
            });
            
            // Create table data
            const tableData = [];
            for (let spotName in machineMap) {
                const m = machineMap[spotName];
                const paybackPct = m.amtPlayed > 0 ? ((m.amtWon / m.amtPlayed) * 100).toFixed(2) : '0.00';
                tableData.push([
                    spotName,
                    m.uniqueId.substring(0, 15),
                    `$${m.fundsIn.toFixed(2)}`,
                    `$${m.fundsOut.toFixed(2)}`,
                    `$${m.netIncome.toFixed(2)}`,
                    `${paybackPct}%`
                ]);
            }
            
            // Calculate totals
            let totalFundsIn = 0, totalFundsOut = 0, totalNetIncome = 0, totalPlayed = 0, totalWon = 0;
            for (let key in machineMap) {
                totalFundsIn += machineMap[key].fundsIn;
                totalFundsOut += machineMap[key].fundsOut;
                totalNetIncome += machineMap[key].netIncome;
                totalPlayed += machineMap[key].amtPlayed;
                totalWon += machineMap[key].amtWon;
            }
            
            const avgPayback = totalPlayed > 0 ? ((totalWon / totalPlayed) * 100).toFixed(2) : '0.00';
            
            tableData.push([
                'TOTALS',
                '',
                `$${totalFundsIn.toFixed(2)}`,
                `$${totalFundsOut.toFixed(2)}`,
                `$${totalNetIncome.toFixed(2)}`,
                `${avgPayback}%`
            ]);
            
            doc.autoTable({
                startY: yPosition,
                head: [['VGT', 'UID', 'Funds In', 'Funds Out', 'Net Income', 'Payback %']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234], fontSize: 10 },
                styles: { fontSize: 9 },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 25, halign: 'right' },
                    3: { cellWidth: 25, halign: 'right' },
                    4: { cellWidth: 30, halign: 'right' },
                    5: { cellWidth: 25, halign: 'right' }
                }
            });
            
            // Save PDF
            const fileName = `${venueName.replace(/[^a-z0-9]/gi, '_')}_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showStatus(`PDF generated successfully: ${fileName}`, 'success');
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            setTimeout(() => {
                statusMessage.className = 'status-message';
            }, 5000);
        }
    </script>
</body>
</html>
